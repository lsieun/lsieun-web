<!-- 标题 -->
<h1 class="w3-center w3-padding-64 w3-tangerine"><span class="w3-tag w3-wide">Generating methods</span></h1>
<!-- 内容 -->

<div style="text-align: right">
    <a title="Table Of Content" href="/archive/java/java_asm_index.html">TOC</a>
    <a href="javascript:void(0);" onclick="toggle_all_sub_note()">Toggle Commentary</a>
</div>

<pre title="HelloWorld.java" class="javacode">
public class HelloWorld {
    private int f;

    public int getF() {
        return this.f;
    }

    public void setF(int f) {
        this.f = f;
    }

    public void checkAndSetF(int f) {
        if (f >= 0) {
            this.f = f;
        } else {
            throw new IllegalArgumentException();
        }
    }
}
</div>

<pre title="HelloWorldDump.java" class="javacode">
import lsieun.utils.FileUtils;
import org.objectweb.asm.*;

public class HelloWorldDump implements Opcodes {

    public static void main(String[] args) throws Exception {
        String relative_path = "sample/HelloWorld.class";
        String filepath = FileUtils.getFilePath(relative_path);

        // 第一步，生成sample.HelloWorld的字节码内容
        byte[] bytes = dump();

        // 第二步，保存字节码内容到文件
        FileUtils.writeBytes(filepath, bytes);
        System.out.println("file://" + filepath);
    }

    public static byte[] dump () throws Exception {
        ClassWriter cw = new ClassWriter(0);

        cw.visit(V1_8, ACC_PUBLIC | ACC_SUPER, "sample/HelloWorld", null, "java/lang/Object", null);

        {
            FieldVisitor fv = cw.visitField(ACC_PRIVATE, "f", "I", null, null);
            fv.visitEnd();
        }
        {
            MethodVisitor mv1 = cw.visitMethod(ACC_PUBLIC, "&lt;init&gt;", "()V", null, null);
            mv1.visitCode();
            mv1.visitVarInsn(ALOAD, 0);
            mv1.visitMethodInsn(INVOKESPECIAL, "java/lang/Object", "&lt;init&gt;", "()V", false);
            mv1.visitInsn(RETURN);
            mv1.visitMaxs(1, 1);
            mv1.visitEnd();
        }
        {
            MethodVisitor mv2 = cw.visitMethod(ACC_PUBLIC, "getF", "()I", null, null);
            mv2.visitCode();
            mv2.visitVarInsn(ALOAD, 0);
            mv2.visitFieldInsn(GETFIELD, "sample/HelloWorld", "f", "I");
            mv2.visitInsn(IRETURN);
            mv2.visitMaxs(1, 1);
            mv2.visitEnd();
        }
        {
            MethodVisitor mv3 = cw.visitMethod(ACC_PUBLIC, "setF", "(I)V", null, null);
            mv3.visitCode();
            mv3.visitVarInsn(ALOAD, 0);
            mv3.visitVarInsn(ILOAD, 1);
            mv3.visitFieldInsn(PUTFIELD, "sample/HelloWorld", "f", "I");
            mv3.visitInsn(RETURN);
            mv3.visitMaxs(2, 2);
            mv3.visitEnd();
        }
        {
            MethodVisitor mv4 = cw.visitMethod(ACC_PUBLIC, "checkAndSetF", "(I)V", null, null);
            mv4.visitCode();
            mv4.visitVarInsn(ILOAD, 1);
            Label else_label = new Label();
            mv4.visitJumpInsn(IFLT, else_label);
            mv4.visitVarInsn(ALOAD, 0);
            mv4.visitVarInsn(ILOAD, 1);
            mv4.visitFieldInsn(PUTFIELD, "sample/HelloWorld", "f", "I");

            Label return_label = new Label();
            mv4.visitJumpInsn(GOTO, return_label);

            mv4.visitLabel(else_label);
            mv4.visitFrame(Opcodes.F_SAME, 0, null, 0, null);
            mv4.visitTypeInsn(NEW, "java/lang/IllegalArgumentException");
            mv4.visitInsn(DUP);
            mv4.visitMethodInsn(INVOKESPECIAL, "java/lang/IllegalArgumentException", "&lt;init&gt;", "()V", false);
            mv4.visitInsn(ATHROW);

            mv4.visitLabel(return_label);
            mv4.visitFrame(Opcodes.F_SAME, 0, null, 0, null);
            mv4.visitInsn(RETURN);
            mv4.visitMaxs(2, 2);
            mv4.visitEnd();
        }
        cw.visitEnd();

        return cw.toByteArray();
    }
}
</div>


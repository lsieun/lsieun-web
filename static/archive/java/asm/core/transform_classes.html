<!-- 标题 -->
<h1 class="w3-center w3-padding-64 w3-tangerine"><span class="w3-tag w3-wide">ClassReader and ClassWriter: Transforming classes</span></h1>
<!-- 内容 -->

<div style="text-align: right">
    <a title="Table Of Content" href="/archive/java/java_asm_index.html">TOC</a>
    <a href="javascript:void(0);" onclick="toggle_all_sub_note()">Toggle Commentary</a>
</div>

<p class="indented">
    So far the <code>ClassReader</code> and <code>ClassWriter</code> components were used alone.
    Things start to become really interesting when these components are used together.
</p>

<p class="indented">
    <span class="text-example">The first step</span> is to direct <span class="text-emphasize">the events</span> produced
    by a <code>ClassReader</code> to a <code>ClassWriter</code>.
    The result is that the class parsed by the class reader is reconstructed by the class writer:
</p>

<pre title="The first step" class="javacode">
byte[] b1 = ...;
ClassWriter cw = new ClassWriter(0);
ClassReader cr = new ClassReader(b1);
cr.accept(cw, 0);
byte[] b2 = cw.toByteArray(); // b2 represents the same class as b1
</pre>

<p class="indented">
    This is not really interesting in itself (there are easier ways to copy a byte array!), but wait.
    <span class="text-example">The next step</span> is to introduce a <code>ClassVisitor</code> between
    <span class="text-key-point">the class reader</span> and <span class="text-key-point">the class writer</span>:
</p>

<pre title="The next step" class="javacode">
byte[] b1 = ...;
ClassWriter cw = new ClassWriter(0);
// cv forwards all events to cw
ClassVisitor cv = new ClassVisitor(ASM4, cw) { };
ClassReader cr = new ClassReader(b1);
cr.accept(cv, 0);
byte[] b2 = cw.toByteArray(); // b2 represents the same class as b1
</pre>

<p class="indented">
    The result does not change, however, because the <code>ClassVisitor</code> event filter does not filter anything.
    But it is now sufficient to filter some events, by overriding some methods, in order to be able to transform a class.
    For example, consider the following <code>ClassVisitor</code> subclass:
</p>

<pre title="ChangeVersionClassAdapter.java" class="javacode">
import org.objectweb.asm.ClassVisitor;
import org.objectweb.asm.Opcodes;

public class ChangeVersionClassAdapter extends ClassVisitor {
    public ChangeVersionClassAdapter(int api, ClassVisitor cv) {
        super(api, cv);
    }

    @Override
    public void visit(int version, int access, String name, String signature, String superName, String[] interfaces) {
        super.visit(Opcodes.V1_7, access, name, signature, superName, interfaces);
    }
}
</pre>

<pre title="App.java" class="javacode">
import lsieun.utils.FileUtils;
import lsieun.utils.ReadUtils;
import org.objectweb.asm.ClassReader;
import org.objectweb.asm.ClassVisitor;
import org.objectweb.asm.ClassWriter;
import org.objectweb.asm.Opcodes;

public class App {
    public static void main(String[] args) {
        String relative_path = "sample/HelloWorld.class";
        String filepath = FileUtils.getFilePath(relative_path);
        byte[] bytes1 = ReadUtils.readByPath(filepath);

        //（1）构建ClassReader
        ClassReader cr = new ClassReader(bytes1);

        //（2）构建ClassWriter
        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);

        //（3）串连ClassVisitor
        // cv forwards all events to cw
        ClassVisitor cv = new ChangeVersionClassAdapter(Opcodes.ASM9, cw);

        //（4）两者进行结合
        cr.accept(cv, 0);

        //（5）重新生成Class
        byte[] bytes2 = cw.toByteArray();

        FileUtils.writeBytes(filepath, bytes2);
    }
}
</pre>

<table class="lamp">
    <tbody>
    <tr>
        <th style="width:34px">
            <img src="/images/lamp.jpg" alt="Note" style="height:32px;width:32px">
        </th>
        <td>
            <b>Note:</b> 使用<code>javap -v -p HelloWorld.class</code>，对修改前和修改后的结果，进行验证。
        </td>

    </tr>
    </tbody>
</table>
<hr>

<p class="indented">
    By modifying other arguments of the <code>visit</code> method you can implement other transformations than just changing the class version.
    For instance you can <span class="text-example">add an interface to the list of implemented interfaces</span>.
    It is also possible to change <span class="text-example">the name of the class</span>,
    but <span class="text-key-point">this requires much more than just changing the name argument</span> in the <code>visit</code> method.
    Indeed the name of the class can appear in many different places inside a compiled class,
    and all these occurrences must be changed to really rename the class.
</p>


<!-- 标题 -->
<h1 class="w3-center w3-padding-64 w3-tangerine"><span class="w3-tag w3-wide">Opcode: Stack</span></h1>
<!-- 内容 -->

<div style="text-align: right">
    <a title="Table Of Content" href="/archive/java/java_classfile_index.html">TOC</a>
    <a href="javascript:void(0);" onclick="toggle_all_sub_note()">Toggle Commentary</a>
</div>

<h2>dup</h2>

<pre title="HelloWorld.java" class="javacode">
public class HelloWorld {
    public void test() {
        int a;
        int b;
        b = a = 2;
    }
}
</pre>

<pre title="test:()V" hidden class="plaintext">
=== === ===  === === ===  === === ===
max_stack = 2
max_locals = 3
code_length = 5
code = 05593C3DB1
=== === ===  === === ===  === === ===
0000: iconst_2             // 05
0001: dup                  // 59
0002: istore_1             // 3C
0003: istore_2             // 3D
0004: return               // B1

LocalVariableTable:
index  start_pc  length  name_and_type
    0         0       5  this:Lsample/HelloWorld;
    1         3       2  a:I
    2         4       1  b:I
</pre>

<h2>dup2</h2>

<pre title="HelloWorld.java" class="javacode">
public class HelloWorld {
    public void test() {
        long a;
        long b;
        b = a = 2;
    }
}
</pre>

<pre title="test:()V" hidden class="plaintext">
=== === ===  === === ===  === === ===
Method test:()V
=== === ===  === === ===  === === ===
max_stack = 4
max_locals = 5
code_length = 7
code = 1400025C4042B1
=== === ===  === === ===  === === ===
0000: ldc2_w          #2   // 140002     || 2
0003: dup2                 // 5C
0004: lstore_1             // 40
0005: lstore_3             // 42
0006: return               // B1
=== === ===  === === ===  === === ===
LocalVariableTable:
index  start_pc  length  name_and_type
    0         0       7  this:Lsample/HelloWorld;
    1         5       2  a:J
    3         6       1  b:J
</pre>

<h2>pop</h2>

<pre title="HelloWorld.java" class="javacode">
public class HelloWorld {
    public void test() {
        Math.max(3, 4);
    }
}
</pre>

<pre title="test:()V" hidden class="plaintext">
=== === ===  === === ===  === === ===
max_stack = 2
max_locals = 1
code_length = 7
code = 0607B8000257B1
=== === ===  === === ===  === === ===
0000: iconst_3             // 06
0001: iconst_4             // 07
0002: invokestatic    #2   // B80002     || java/lang/Math.max:(II)I
0005: pop                  // 57
0006: return               // B1

LocalVariableTable:
index  start_pc  length  name_and_type
    0         0       7  this:Lsample/HelloWorld;
</pre>

<h2>pop2</h2>

<pre title="HelloWorld.java" class="javacode">
public class HelloWorld {
    public void test() {
        Math.max(3L, 4L);
    }
}
</pre>

<pre title="test:()V" hidden class="plaintext">
=== === ===  === === ===  === === ===
Method test:()V
=== === ===  === === ===  === === ===
max_stack = 4
max_locals = 1
code_length = 11
code = 140002140004B8000658B1
=== === ===  === === ===  === === ===
0000: ldc2_w          #2   // 140002     || 3
0003: ldc2_w          #4   // 140004     || 4
0006: invokestatic    #6   // B80006     || java/lang/Math.max:(JJ)J
0009: pop2                 // 58
0010: return               // B1
=== === ===  === === ===  === === ===
LocalVariableTable:
index  start_pc  length  name_and_type
    0         0      11  this:Lsample/HelloWorld;
</pre>

<h2>dup_x2</h2>

<pre title="HelloWorld.java" class="javacode">
public class HelloWorld {
    public static int test(int[] array, int i, int value) {
        return array[i] = value;
    }
}
</pre>

<pre title="test:([III)I" hidden class="plaintext">
=== === ===  === === ===  === === ===
Method test:([III)I
=== === ===  === === ===  === === ===
max_stack = 4
max_locals = 3
code_length = 6
code = 2A1B1C5B4FAC
=== === ===  === === ===  === === ===
0000: aload_0              // 2A
0001: iload_1              // 1B
0002: iload_2              // 1C
0003: dup_x2               // 5B
0004: iastore              // 4F
0005: ireturn              // AC
=== === ===  === === ===  === === ===
LocalVariableTable:
index  start_pc  length  name_and_type
    0         0       6  array:[I
    1         0       6  i:I
    2         0       6  value:I
</pre>

<h2>dup2_x2</h2>

<pre title="HelloWorld.java" class="javacode">
public class HelloWorld {
    public static long test(long[] array, int i, long value) {
        return array[i] = value;
    }
}
</pre>

<pre title="test:([JIJ)J" hidden class="plaintext">
=== === ===  === === ===  === === ===
Method test:([JIJ)J
=== === ===  === === ===  === === ===
max_stack = 6
max_locals = 4
code_length = 6
code = 2A1B205E50AD
=== === ===  === === ===  === === ===
0000: aload_0              // 2A
0001: iload_1              // 1B
0002: lload_2              // 20
0003: dup2_x2              // 5E
0004: lastore              // 50
0005: lreturn              // AD
=== === ===  === === ===  === === ===
LocalVariableTable:
index  start_pc  length  name_and_type
    0         0       6  array:[J
    1         0       6  i:I
    2         0       6  value:J
</pre>

<h2>swap</h2>

<p class="indented">
    对于<code>swap</code>，我并没有找到一段代码能够直接生成<code>swap</code>指令。
</p>

<pre title="HelloWorld.java" class="javacode">
public class HelloWorld {
    public static int test() {
        long timestamp = System.currentTimeMillis();
        return (int) (timestamp % 24);
    }
}
</pre>

<pre title="App.java" class="javacode">
public class App {
    public static void main(String[] args) {
        int value = HelloWorld.test();
        if (value &lt; 6) {
            System.out.println("Good Night");
        } else if (value &lt; 12) {
            System.out.println("Good Morning");
        } else if (value &lt; 18) {
            System.out.println("Good Afternoon");
        } else {
            System.out.println("Good Evening");
        }
    }
}
</pre>

<pre title="ASM" class="plaintext">
mv.visitInsn(DUP);
mv.visitFieldInsn(GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
mv.visitInsn(SWAP);
mv.visitMethodInsn(INVOKEVIRTUAL, "java/io/PrintStream", "println", "(I)V", false);
</pre>

<h2>Summing Up</h2>

<p>
    总结：
</p>

<ul>
    <li>第一，这里与operand stack密切相关的opcode，大体分为三类：dup、pop和swap。</li>
    <li>第二，从JVM execution model的角度上来说，这些opcode是如何影响frame当中的operand stack和local variable。</li>
</ul>

<div class="w3-display-container w3-center">
    <img class="w3-image w3-center" src="/images/java/jvm/jvm_stack_a_frame.png" alt="Frames"/>
</div>

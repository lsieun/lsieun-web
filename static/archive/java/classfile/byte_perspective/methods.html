<!-- 标题 -->
<h1 class="w3-center w3-padding-64 w3-tangerine"><span class="w3-tag w3-wide">Methods</span></h1>
<!-- 内容 -->

<div style="text-align: right">
    <a title="Table Of Content" href="/archive/java/java_classfile_index.html">TOC</a>
    <a href="javascript:void(0);" onclick="toggle_all_sub_note()">Toggle Commentary</a>
</div>

<h2>Methods</h2>

<div title="ClassFile" class="plaintext">
ClassFile {
    u4             magic;
    u2             minor_version;
    u2             major_version;
    u2             constant_pool_count;
    cp_info        constant_pool[constant_pool_count-1];
    u2             access_flags;
    u2             this_class;
    u2             super_class;
    u2             interfaces_count;
    u2             interfaces[interfaces_count];
    u2             fields_count;
    field_info     fields[fields_count];
    ------------------------------------------------------------------------
    u2             methods_count;
    method_info    methods[methods_count];
    ------------------------------------------------------------------------
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}
</div>

<ul>
    <li>
        <b>methods_count</b>: The value of the <code>methods_count</code> item gives the number of <code>method_info</code> structures in the methods table.
    </li>
    <li>
        <b>methods[]</b>:
        Each value in the methods table must be a <code>method_info</code> structure giving a complete description of a method in this class or interface. If neither of the <code>ACC_NATIVE</code> and <code>ACC_ABSTRACT</code> flags are set in the <code>access_flags</code> item of a <code>method_info</code> structure, the Java Virtual Machine instructions implementing the method are also supplied.

        The <code>method_info</code> structures represent all methods declared by this class or interface type, including <b>instance methods</b>, <b>class methods</b>, <b>instance initialization methods</b>, and <b>any class or interface initialization method</b>. The <code>methods</code> table does not include items representing methods that are inherited from superclasses or superinterfaces.
    </li>
</ul>

<p>
    Each method, including each <b>instance initialization method</b> and <b>the class or interface initialization method</b>, is described by a <code>method_info</code> structure.

    No two methods in one class file may have the same <b>name</b> and <b>descriptor</b>.

    The structure has the following format:
</p>

<div title="method_info" class="plaintext">
method_info {
    u2             access_flags;
    u2             name_index;
    u2             descriptor_index;
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}
</div>

<div class="w3-display-container w3-center">
    <img class="w3-image w3-center" src="/images/java/classfile/classfile_methodinfo.png" alt="methodinfo"/>
</div>

<h2>access_flags</h2>

<table class="w3-table-all w3-hoverable w3-centered">
    <tr class="w3-green">
        <th>Flag Value</th>
        <th>Flag Name</th>
        <th>Interpretation</th>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0001</code></td>
        <td>ACC_PUBLIC</td>
        <td class="w3-left-align">Declared <code>public</code>; may be accessed from outside its package. </td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0002</code></td>
        <td>ACC_PRIVATE</td>
        <td class="w3-left-align">Declared <code>private</code>; accessible only within the defining class. </td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0004</code></td>
        <td>ACC_PROTECTED</td>
        <td class="w3-left-align">Declared <code>protected</code>; may be accessed within subclasses. </td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0008</code></td>
        <td>ACC_STATIC</td>
        <td class="w3-left-align">Declared <code>static</code>.</td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0010</code></td>
        <td>ACC_FINAL</td>
        <td class="w3-left-align">Declared <code>final</code>; must not be overridden</td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0020</code></td>
        <td>ACC_SYNCHRONIZED</td>
        <td class="w3-left-align">Declared <code>synchronized</code>; invocation is wrapped by a monitor use.</td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0040</code></td>
        <td>ACC_BRIDGE</td>
        <td class="w3-left-align">A bridge method, generated by the compiler.</td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0080</code></td>
        <td>ACC_VARARGS</td>
        <td class="w3-left-align">Declared with variable number of arguments.</td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0100</code></td>
        <td>ACC_NATIVE</td>
        <td class="w3-left-align">Declared <code>native</code>; implemented in a language other than Java.</td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0200</code></td>
        <td></td>
        <td class="w3-left-align"></td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0400</code></td>
        <td>ACC_ABSTRACT</td>
        <td class="w3-left-align">Declared <code>abstract</code>; no implementation is provided.</td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x0800</code></td>
        <td>ACC_STRICT</td>
        <td class="w3-left-align">Declared <code>strictfp</code>; floating-point mode is FP-strict.</td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x1000</code></td>
        <td>ACC_SYNTHETIC</td>
        <td class="w3-left-align">Declared <code>synthetic</code>; not present in the source code. </td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x2000</code></td>
        <td></td>
        <td class="w3-left-align"></td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x4000</code></td>
        <td></td>
        <td class="w3-left-align"></td>
    </tr>
    <tr class="w3-hover-blue">
        <td><code>0x8000</code></td>
        <td></td>
        <td class="w3-left-align"></td>
    </tr>
</table>

<h3>ACC_PUBLIC+</h3>

<div title="HelloWorld.java" class="javacode">
public abstract class HelloWorld  {
    void testDefault() {
        //[]
    }

    public void testPublic() {
        //[ACC_PUBLIC]
    }

    private void testPrivate() {
        //[ACC_PRIVATE]
    }

    protected void testProtected() {
        //[ACC_PROTECTED]
    }

    static void testStatic() {
        //[ACC_STATIC]
    }

    final void testFinal() {
        //[ACC_FINAL]
    }

    synchronized void testSynchronized() {
        //[ACC_SYNCHRONIZED]
    }

    void testVarArgs(String name, int age, String ... info) {
        //[ACC_VARARGS]
    }

    abstract void testAbstract(); //[ACC_ABSTRACT]

    strictfp void testStrict() {
        //[ACC_STRICT]
    }
}
</div>

<div title="Example" class="plaintext">
methods_count='000B' (11)
methods
    MethodInfo {Value='&lt;init&gt;:()V', AccessFlags='[ACC_PUBLIC]', Attrs='[Code]', HexCode='0001000400050001...'}
    MethodInfo {Value='testDefault:()V', AccessFlags='[]', Attrs='[Code]', HexCode='0000000B00050001...'}
    MethodInfo {Value='testPublic:()V', AccessFlags='[ACC_PUBLIC]', Attrs='[Code]', HexCode='0001000C00050001...'}
    MethodInfo {Value='testPrivate:()V', AccessFlags='[ACC_PRIVATE]', Attrs='[Code]', HexCode='0002000D00050001...'}
    MethodInfo {Value='testProtected:()V', AccessFlags='[ACC_PROTECTED]', Attrs='[Code]', HexCode='0004000E00050001...'}
    MethodInfo {Value='testStatic:()V', AccessFlags='[ACC_STATIC]', Attrs='[Code]', HexCode='0008000F00050001...'}
    MethodInfo {Value='testFinal:()V', AccessFlags='[ACC_FINAL]', Attrs='[Code]', HexCode='0010001000050001...'}
    MethodInfo {Value='testSynchronized:()V', AccessFlags='[ACC_SYNCHRONIZED]', Attrs='[Code]', HexCode='0020001100050001...'}
    MethodInfo {Value='testVarArgs:(Ljava/lang/String;I[Ljava/lang/String;)V', AccessFlags='[ACC_VARARGS]', Attrs='[Code, MethodParameters]', HexCode='0080001200130002...'}
    MethodInfo {Value='testAbstract:()V', AccessFlags='[ACC_ABSTRACT]', Attrs='[]', HexCode='0400001B00050000'}
    MethodInfo {Value='testStrict:()V', AccessFlags='[ACC_STRICT]', Attrs='[Code]', HexCode='0800001C00050001...'}
</div>

<h3>ACC_BRIDGE</h3>

<div title="HelloWorld.java" class="javacode">
public class HelloWorld implements Comparable&lt;HelloWorld&gt; {
    @Override
    public int compareTo(HelloWorld o) {
        return 0;
    }
}
</div>

<p>
    在ClassFile当中，有两个<code>compareTo</code>方法，但两者的descriptor有所不同。值得注意的是第二个<code>compareTo</code>方法（<code>compareTo:(Ljava/lang/Object;)I</code>）带有<code>ACC_BRIDGE</code>标识。简单来说，它是由于Type Erase造成的。
</p>

<div title="Example: ACC_BRIDGE" class="plaintext">
methods_count='0003' (3)
methods
    MethodInfo {Value='&lt;init&gt;:()V', AccessFlags='[ACC_PUBLIC]', Attrs='[Code]', HexCode='0001000600070001...'}
    MethodInfo {Value='compareTo:(Lsample/HelloWorld;)I', AccessFlags='[ACC_PUBLIC]', Attrs='[Code, MethodParameters]', HexCode='0001000D000E0002...'}
    MethodInfo {Value='compareTo:(Ljava/lang/Object;)I', AccessFlags='[ACC_PUBLIC,ACC_BRIDGE,ACC_SYNTHETIC]', Attrs='[Code, MethodParameters]', HexCode='1041000D00110002...'}
</div>

<p>
    从Java语言的角度来说，<code>Comparable</code>是一个泛型接口，其定义如下：
</p>

<div title="Comparable.java" class="javacode">
public interface Comparable&lt;T&gt; {
    public int compareTo(T o);
}
</div>

<p>
    对于Java来说，它并不支持真正的泛型，或者称之为“伪泛型”。换句话说，在JavaFile向ClassFile的转换过程中，泛型需要经历一个Type Erase的过程。
</p>

<p>
    在ClassFile中，<code>Comparable.class</code>是这样的：
</p>

<div title="Example: Comparable.class" class="plaintext">
methods_count='0001' (1)
methods
    MethodInfo {Value='compareTo:(Ljava/lang/Object;)I', AccessFlags='[ACC_PUBLIC,ACC_ABSTRACT]', Attrs='[Signature]', HexCode='0401000300040001...'}
</div>

<h3>ACC_NATIVE</h3>

<p>
    <code>java.lang.System</code>的<code>arraycopy</code>方法
</p>

<div title="Example: ACC_NATIVE" class="plaintext">
MethodInfo {Value='arraycopy:(Ljava/lang/Object;ILjava/lang/Object;II)V', AccessFlags='[ACC_PUBLIC,ACC_STATIC,ACC_NATIVE]', Attrs='[]', HexCode='0109009A009B0000'}
</div>

<h3>ACC_SYNTHETIC</h3>

<p>
    在<code>HelloWorld$InnerClass.class</code>内会生成新的方法<code>access$002</code>，并带有<code>ACC_SYNTHETIC</code>标志。
</p>

<div title="HelloWorld.java" class="javacode">
public class HelloWorld {
    public class InnerClass { // 可以试试将这行的public变成private
        private int value;
    }

    private void test() {
        InnerClass instance = new InnerClass();
        instance.value = 100;
    }
}
</div>

<div title="Example: ACC_SYNTHETIC" class="plaintext">
methods_count='0002' (2)
methods
    MethodInfo {Value='&lt;init&gt;:(Lsample/HelloWorld;)V', AccessFlags='[ACC_PUBLIC]', Attrs='[Code, MethodParameters]', HexCode='0001000A000B0002...'}
    MethodInfo {Value='access$002:(Lsample/HelloWorld$InnerClass;I)I', AccessFlags='[ACC_STATIC,ACC_SYNTHETIC]', Attrs='[Code]', HexCode='1008001400150001...'}
</div>

<p>
    下面的代码会将Lambda Expression(<code>(i) -> i + 5</code>)生成名为<code>lambda$main$0</code>的方法，并带有<code>ACC_SYNTHETIC</code>标志。
</p>

<div title="HelloWorld.java" class="javacode">
import java.util.function.Function;

public class HelloWorld {
    public static void main(String[] args) {
        Function&lt;Integer, Integer&gt; func = (i) -> i + 5;
        Integer value = func.apply(10);
        System.out.println(value);
    }
}
</div>

<div title="Example: ACC_SYNTHETIC" class="plaintext">
methods_count='0003' (3)
methods
    MethodInfo {Value='&lt;init&gt;:()V', AccessFlags='[ACC_PUBLIC]', Attrs='[Code]', HexCode='0001000B000C0001...'}
    MethodInfo {Value='main:([Ljava/lang/String;)V', AccessFlags='[ACC_PUBLIC,ACC_STATIC]', Attrs='[Code, MethodParameters]', HexCode='0009001200130002...'}
    MethodInfo {Value='lambda$main$0:(Ljava/lang/Integer;)Ljava/lang/Integer;', AccessFlags='[ACC_PRIVATE,ACC_STATIC,ACC_SYNTHETIC]', Attrs='[Code, MethodParameters]', HexCode='100A001D001E0002...'}
</div>

<p>
    在使用<code>javap</code>的时候，注意使用<code>-p</code>选项
</p>

<div title="javap" class="plaintext">
$ javap -v -p HelloWorld.class
... ...
  private static java.lang.Integer lambda$main$0(java.lang.Integer);
    descriptor: (Ljava/lang/Integer;)Ljava/lang/Integer;
    flags: ACC_PRIVATE, ACC_STATIC, ACC_SYNTHETIC
    Code:
      stack=2, locals=1, args_size=1
         0: aload_0
         1: invokevirtual #8                  // Method java/lang/Integer.intValue:()I
         4: iconst_5
         5: iadd
         6: invokestatic  #3                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
         9: areturn
      LineNumberTable:
        line 7: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      10     0     i   Ljava/lang/Integer;
    MethodParameters:
      Name                           Flags
      i                              synthetic
... ...
</div>

<h2>&lt;init&gt; and &lt;clinit&gt;</h2>

<div class="w3-panel w3-pale-blue w3-leftbar w3-border-blue">
    <p>
        init = initializer
    </p>
    <p>
        clinit = class initializer
    </p>
</div>

<h3>&lt;init&gt;</h3>

<div title="HelloWorld.java" class="javacode">
public class HelloWorld {

}
</div>

<div title="Example: init" class="plaintext">
methods_count='0001' (1)
methods
    MethodInfo {Value='&lt;init&gt;:()V', AccessFlags='[ACC_PUBLIC]', Attrs='[Code]', HexCode='0001000400050001...'}
</div>

<h3>&lt;clinit&gt;</h3>

<div title="HelloWorld.java" class="javacode">
public class HelloWorld {
    static {
        System.out.println("Java");
    }
}
</div>

<div title="Example: clinit" class="plaintext">
methods_count='0002' (2)
methods
    MethodInfo {Value='&lt;init&gt;:()V', AccessFlags='[ACC_PUBLIC]', Attrs='[Code]', HexCode='0001000700080001...'}
    MethodInfo {Value='&lt;clinit&gt;:()V', AccessFlags='[ACC_STATIC]', Attrs='[Code]', HexCode='0008000E00080001...'}
</div>








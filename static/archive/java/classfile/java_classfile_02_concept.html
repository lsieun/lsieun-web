<!-- 标题 -->
<h1 class="w3-center w3-padding-64 w3-tangerine"><span class="w3-tag w3-wide">Java ClassFile: (2) Concept</span></h1>
<!-- 内容 -->

<div style="text-align: right">
    <a title="Table Of Content" href="/archive/java/java_classfile_index.html">TOC</a>
    <a href="javascript:void(0);" onclick="toggle_all_sub_note()">Toggle Commentary</a>
</div>

<h2>ClassFile Structure</h2>

<div title="ClassFile" class="plaintext">
ClassFile {
    ------------------------------------------------------------------------
    u4             magic;                                 // Magic Number部分
    ------------------------------------------------------------------------
    u2             minor_version;
    u2             major_version;                         // Version部分
    ------------------------------------------------------------------------
    u2             constant_pool_count;
    cp_info        constant_pool[constant_pool_count-1];  // 常量池部分
    ------------------------------------------------------------------------
    u2             access_flags;
    u2             this_class;                            // Class Info部分
    u2             super_class;
    u2             interfaces_count;
    u2             interfaces[interfaces_count];
    ------------------------------------------------------------------------
    u2             fields_count;
    field_info     fields[fields_count];                 // fields部分
    ------------------------------------------------------------------------
    u2             methods_count;
    method_info    methods[methods_count];               // methods部分
    ------------------------------------------------------------------------
    u2             attributes_count;
    attribute_info attributes[attributes_count];         // attributes部分
    ------------------------------------------------------------------------
}
</div>

<p class="indented">
    The JVM Specification describes the <b>class file format</b> using <b>tables</b>.
    <sub class="my_note" style="color:green">笔记：第一，java class file format是由table来描述</sub>
    Each <b>table</b> has a name and shows an ordered list of <b>items</b> that can appear in a class file.
    Items appear in the table in the order in which they appear in the class file.
    <sub class="my_note" style="color:green">笔记：第二，table由多个item组成。在table当中的多个item之间是有排列顺序的。</sub>
    Each <b>item</b> has a <b>type</b>, a <b>name</b>, and a <b>count</b>.
    <sub class="my_note" style="color:green">笔记：第三，item由type、name和count组成。</sub>
    The <b>type</b> is either <b>a table name</b> or one of the "primitive types".
    All values stored in items of type <code>u1</code>, <code>u2</code>, <code>u4</code>, and <code>u8</code> appear in the class file in big-endian order.
    <sub class="my_note" style="color:green">笔记：第四，type可以是简单的类型（<code>u1</code>, <code>u2</code>, <code>u4</code>, and <code>u8</code>），也可以是其它的table类型。</sub>
    <img src="/images/note.png" onclick="toggle_paragraph_sub_note(this)"/>
</p>

<ul>
    <li><code>u1</code>: an unsigned 8-bit integer</li>
    <li><code>u2</code>: an unsigned 16-bit integer in big-endian byte order</li>
    <li><code>u4</code>: an unsigned 32-bit integer in big-endian byte order</li>
    <li><code>u8</code>: an unsigned 64-bit integer in big-endian byte order</li>
    <li><code>table</code>: an array of variable-length items of some type.</li>
</ul>

<div class="w3-panel w3-pale-blue w3-leftbar w3-border-blue">
    <p>总结</p>
    <ul>
        <li>第一点，从结构上来说，ClassFile是由magic number、compiler version、constant pool、class info、fields、methods和attributes组成。</li>
        <li>第二点，从概念上来说，ClassFile涉及到<code>u1</code>, <code>u2</code>, <code>u4</code>, <code>u8</code>和<code>table</code>这些概念。</li>
    </ul>
</div>

<h2>Java Architecture</h2>

<p>
    Java's architecture arises out of four distinct but interrelated technologies,
    each of which is defined by a separate specification from Sun Microsystems:
</p>

<ul>
    <li>the Java programming language</li>
    <li>the Java class file format</li>
    <li>the Java Application Programming Interface</li>
    <li>the Java Virtual Machine</li>
</ul>

<div class="w3-panel w3-light-grey w3-border w3-round">
    <p>
        有一个“子贡问政”的故事，它说明了三个事物之间的重要性程度：民信 &gt; 食物 &gt; 军队。
    </p>
    <ul>
        <li>子贡问政。</li>
        <li>子曰：足食，足兵，民信之矣。</li>
        <li>子贡曰：必不得已而去，于斯三者何先？</li>
        <li>曰：去兵。</li>
        <li>子贡曰：必不得已而去，于斯二者何先？</li>
        <li>曰：去食。自古皆有死，民无信不立。</li>
    </ul>
    <p>
        在Java Architecture中，要对这四个部分进行一个重要性的排序，IMHO，它是一个这样的结果：
        JVM &gt; Java class file format &gt; Java API &gt; Java Language。
        这个重要性的排序，是我自己的理解，很可能是不对的，大家也可以有自己的理解。
    </p>
</div>

<p class="indented">
    When you write and run a Java program, you are tapping the power of these four technologies.
    You express the program in <b>source files</b> written in the <b>Java programming language</b>,
    compile the source to <b>Java class files</b>, and run the class files on a <b>Java Virtual Machine</b>.
    When you write your program, you access system resources (such as I/O, for example) by calling methods in the classes
    that implement the <b>Java Application Programming Interface</b>, or Java API.
    As your program runs, it fulfills your program's Java API calls by invoking methods in class files that implement the Java API.
    <sub class="my_note" style="color:blue">笔记：在编写代码的过程当中，这四个部分紧密联系在一起。</sub>
    <img src="/images/note.png" onclick="toggle_paragraph_sub_note(this)"/>
</p>

<div class="w3-panel w3-pale-blue w3-leftbar w3-border-blue">
    <p>总结</p>
    <ul>
        <li>第一点，Java Architecture由组成Java programming language、Java class file format、 Java API和JVM四个部分组成。</li>
        <li>第二点，对这四个组成部分进行一个重要性排序。</li>
        <li>第三点，在实际的使用当中，这四个组成部分是密不可分的。</li>
        <li>第四点，希望Java Architecture这个概念能帮助大家“格物致知”。无论是学习本课程，还是学习其它的课程，把当前的内容放到这个Java Architecture进行审视，看看当前的内容属于哪一部分，这个内容归并到相应的“方格子”当中，以理清自己的学习思路。</li>
    </ul>
</div>

<h2>Mapping From JavaFile to ClassFile</h2>

<p class="indented">
    The <b>Java Virtual Machine</b> knows nothing of the <b>Java programming language</b>, only of a particular binary format, <b>the class file format</b>.
</p>

<p class="indented">
    <b>Bytecode</b>(Java ClassFile) is nothing but the intermediate representation of <b>Java source code</b> which is produced by the Java compiler by compiling that source code.
</p>

<div class="w3-display-container w3-center">
    <img class="w3-image w3-center" src="/images/java/classfile/mapping_from_java_file_to_class_file.png" alt="Mapping From JavaFile to ClassFile"/>
</div>


<p>
    我们想要强调三个观点：
</p>

<ul>
    <li>
        第一点，任意一个<code>.java</code>文件都是Java programming language的一种具体表现形式；任意一个<code>.class</code>文件都是Java class file format的一种具体表现形式。
    </li>
    <li>
        第二点，Java programming language中所提供的语言特性，必须在Java class file format层面得到支持。
    </li>
    <li>
        第三点，对于一个<code>.java</code>通过javac编译成相应的<code>.class</code>文件，其本质是从JavaFile向ClassFile的语义映射（Mapping）。
    </li>
</ul>

<p>

</p>

<h2>JDK Tools: javap</h2>

<p>
    这里讲<code>javac</code>、<code>java</code>、<code>javap</code>与Java ClassFile之间的关系。
</p>

<div class="w3-panel w3-pale-blue w3-leftbar w3-border-blue">
    <p>
        HelloWorld.java  --&gt; javac --&gt; HelloWorld.class  --&gt; java  --&gt; JVM
    </p>
    <p>
        HelloWorld.class --&gt; javap  --&gt; print a human readable version of HelloWorld.class
    </p>
</div>

<p>
    javac has the following options:
</p>

<ul>
    <li>
        <code>-d &lt;directory&gt;</code>: The directory in which (or beneath which) class files should be stored.
        By default, javac stores the <code>.class</code> files it generates in the same directory as the <code>.java</code> file that those classes were defined in.
    </li>
    <li>
        <code>-g</code>: Generate all debugging info
    </li>
    <li>
        <code>-g:none</code>: Generate no debugging info
    </li>
    <li>
        <code>-g:{lines,vars,source}</code>: Generate only some debugging info
    </li>
    <li>
        <code>-parameters</code>: Stores formal parameter names of constructors and methods in the generated class file so that the method <code>java.lang.reflect.Executable.getParameters</code> from the Reflection API can retrieve them.
    </li>
    <li>
        <code>-source &lt;version&gt;</code>: Control the Java version that javac will accept.
    </li>
    <li>
        <code>-target &lt;version&gt;</code>: Control the version of class files that javac will output.
    </li>
</ul>

<div title="javac example" class="plaintext">
javac -g:vars Main.java
javac -g:vars,lines Main.java
</div>

<p>
    javap has the following options:
</p>

<ul>
    <li>
        <code>-c</code>: Decompile bytecode
    </li>
    <li>
        <code>-l</code>: Print line number and local variable tables
    </li>
    <li>
        <code>-p</code>: Include private methods
    </li>
    <li>
        <code>-s</code>: Print internal type signatures
    </li>
    <li>
        <code>-v</code>: Verbose mode (include constant pool information)
    </li>
</ul>

<div title="HelloWorld.java" class="javacode">
public class HelloWorld {
    private static int add(int a, int b) {
        int sum = a + b;
        return sum;
    }
}
</div>

<div title="javac" class="plaintext">
javac -g HelloWorld.java
</div>

<h3>no option</h3>

<div title="javap" class="plaintext">
$ javap HelloWorld.class
Compiled from "HelloWorld.java"
public class sample.HelloWorld {
  public sample.HelloWorld();
}
</div>

<h3>javap -s</h3>

<div title="javap -s" class="plaintext">
$ javap -s HelloWorld.class
Compiled from "HelloWorld.java"
public class sample.HelloWorld {
  public sample.HelloWorld();
    descriptor: ()V
}
</div>

<h3>javap -c</h3>

<div title="javap -c" class="plaintext">
$ javap -c HelloWorld.class
Compiled from "HelloWorld.java"
public class sample.HelloWorld {
  public sample.HelloWorld();
    Code:
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V
       4: return
}
</div>

<h3>javap -l</h3>

<div title="javap -l" class="plaintext">
$ javap -l HelloWorld.class
Compiled from "HelloWorld.java"
public class sample.HelloWorld {
  public sample.HelloWorld();
    LineNumberTable:
      line 3: 0
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       5     0  this   Lsample/HelloWorld;
}
</div>

<h3>javap -v</h3>

<div title="javap -v" class="plaintext">
$ javap -v HelloWorld.class
Classfile /D:/git-repo/java8-classfile-tutorial/target/classes/sample/HelloWorld.class
  Last modified 2020-9-25; size 263 bytes
  MD5 checksum 701f765fabb6a98f6054e21865fadddd
  Compiled from "HelloWorld.java"
public class sample.HelloWorld
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #3.#12         // java/lang/Object."&lt;init&gt;":()V
   #2 = Class              #13            // sample/HelloWorld
   #3 = Class              #14            // java/lang/Object
   #4 = Utf8               &lt;init&gt;
   #5 = Utf8               ()V
   #6 = Utf8               Code
   #7 = Utf8               LineNumberTable
   #8 = Utf8               add
   #9 = Utf8               (II)I
  #10 = Utf8               SourceFile
  #11 = Utf8               HelloWorld.java
  #12 = NameAndType        #4:#5          // "&lt;init&gt;":()V
  #13 = Utf8               sample/HelloWorld
  #14 = Utf8               java/lang/Object
{
  public sample.HelloWorld();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V
         4: return
      LineNumberTable:
        line 3: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lsample/HelloWorld;
}
SourceFile: "HelloWorld.java"
</div>

<h3>javap -p</h3>

<div title="javap -p" class="plaintext">
$ javap -p HelloWorld.class
Compiled from "HelloWorld.java"
public class sample.HelloWorld {
  public sample.HelloWorld();
  private static int add(int, int);
}
</div>

<h2>References</h2>

<ul>
    <li><a class="external" href="https://docstore.mik.ua/orelly/java/javanut/ch16_01.htm" target="_blank">Java In a Nutshell: JDK Tools</a></li>
</ul>

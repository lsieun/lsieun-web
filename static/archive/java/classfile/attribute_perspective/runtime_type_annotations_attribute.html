<!-- 标题 -->
<h1 class="w3-center w3-padding-64 w3-tangerine"><span class="w3-tag w3-wide">Runtime Type Annotations</span></h1>
<!-- 内容 -->

<div style="text-align: right">
    <a title="Table Of Content" href="/archive/java/java_classfile_index.html">TOC</a>
    <a href="javascript:void(0);" onclick="toggle_all_sub_note()">Toggle Commentary</a>
</div>

<h2>Intro</h2>

<h3>RuntimeVisibleTypeAnnotations</h3>

<p class="indented">
    The <code>RuntimeVisibleTypeAnnotations</code> attribute is an <b>variable-length</b> attribute in the <code>attributes</code> table of a <code>ClassFile</code>, <code>field_info</code>, or <code>method_info</code> structure, or <code>Code</code> attribute.
</p>

<p class="indented">
    The <code>RuntimeVisibleTypeAnnotations</code> attribute records <b>run-time visible annotations</b> on <b>types used</b> in the declaration of the corresponding class, field, or method, or in an expression in the corresponding method body.
</p>

<p class="indented">
    The <code>RuntimeVisibleTypeAnnotations</code> attribute also records <b>run-time visible annotations</b> on <b>type parameter</b> declarations of generic classes, interfaces, methods, and constructors.
</p>

<p class="indented">
    The Java Virtual Machine must make these annotations available so they can be returned by <b>the appropriate reflective APIs</b>.
</p>

<p class="indented"></p>
<p class="indented"></p>

<p class="indented">
    There may be <b>at most one</b> <code>RuntimeVisibleTypeAnnotations</code> attribute in the attributes table of a <code>ClassFile</code>, <code>field_info</code>, or <code>method_info</code> structure, or <code>Code</code> attribute.
</p>

<div class="w3-panel w3-light-grey w3-border w3-round">
    <ul>
        <li>长度：variable-length</li>
        <li>位置：ClassFile, field_info, method_info, Code</li>
        <li>数量：0或1</li>
    </ul>
</div>

<p class="indented">
    An <code>attributes</code> table contains a <code>RuntimeVisibleTypeAnnotations</code> attribute only if types are annotated in kinds of declaration or expression that correspond to the parent structure or attribute of the attributes table.
</p>

<p class="indented">
    For example, all annotations on types in the implements clause of a class declaration are recorded in the <code>RuntimeVisibleTypeAnnotations</code> attribute of the class's <code>ClassFile</code> structure.
    Meanwhile, all annotations on the type in a field declaration are recorded in the <code>RuntimeVisibleTypeAnnotations</code> attribute of the field's <code>field_info</code> structure.
</p>

<p>
    The <code>RuntimeVisibleTypeAnnotations</code> attribute has the following format:
</p>

<div title="RuntimeVisibleTypeAnnotations_attribute" class="plaintext">
RuntimeVisibleTypeAnnotations_attribute {
    u2              attribute_name_index;
    u4              attribute_length;
    u2              num_annotations;
    type_annotation annotations[num_annotations];
}
</div>

<div class="w3-panel w3-light-grey w3-border w3-round">
    <p>
        对于<code>type_annotation</code>的类型，可以参考<a href="/archive/java/classfile/attribute_perspective/type_annotation.html" target="_blank">这里</a>。
    </p>
</div>

<p>
    The items of the <code>RuntimeVisibleTypeAnnotations_attribute</code> structure are as follows:
</p>

<ul>
    <li>
        <code>attribute_name_index</code>: The value of the <code>attribute_name_index</code> item must be a valid index into the <code>constant_pool</code> table.
        The <code>constant_pool</code> entry at that index must be a <code>CONSTANT_Utf8_info</code> structure representing the string "RuntimeVisibleTypeAnnotations".
    </li>
    <li>
        <code>attribute_length</code>: The value of the <code>attribute_length</code> item indicates the length of the attribute, excluding the initial six bytes.
    </li>
    <li>
        <code>num_annotations</code>: The value of the <code>num_annotations</code> item gives the number of run-time visible type annotations represented by the structure.
    </li>
    <li>
        <code>annotations[]</code>: Each entry in the <code>annotations</code> table represents a single run-time visible annotation on a type used in a declaration or expression.
    </li>

</ul>


<h3>RuntimeInvisibleTypeAnnotations</h3>

<p class="indented">
    The <code>RuntimeInvisibleTypeAnnotations</code> attribute is an <b>variable-length</b> attribute in the <code>attributes</code> table of a <code>ClassFile</code>, <code>field_info</code>, or <code>method_info</code> structure, or <code>Code</code> attribute.


</p>

<p class="indented">
    The <code>RuntimeInvisibleTypeAnnotations</code> attribute records <b>run-time invisible annotations</b> on <b>types used</b> in the corresponding declaration of a class, field, or method, or in an expression in the corresponding method body.
</p>

<p class="indented">
    The <code>RuntimeInvisibleTypeAnnotations</code> attribute also records annotations on <b>type parameter</b> declarations of generic classes, interfaces, methods, and constructors.
</p>

<p class="indented">
    There may be <b>at most one</b> <code>RuntimeInvisibleTypeAnnotations</code> attribute in the <code>attributes</code> table of a <code>ClassFile</code>, <code>field_info</code>, or <code>method_info</code> structure, or <code>Code</code> attribute.
</p>

<div class="w3-panel w3-light-grey w3-border w3-round">
    <ul>
        <li>长度：variable-length</li>
        <li>位置：ClassFile, field_info, method_info, Code</li>
        <li>数量：0或1</li>
    </ul>
</div>

<p class="indented">
    An <code>attributes</code> table contains a <code>RuntimeInvisibleTypeAnnotations</code> attribute only if types are annotated in kinds of declaration or expression that correspond to the parent structure or attribute of the <code>attributes</code> table.
</p>

<p>
    The <code>RuntimeInvisibleTypeAnnotations</code> attribute has the following format:
</p>

<div title="RuntimeInvisibleTypeAnnotations_attribute" class="plaintext">
RuntimeInvisibleTypeAnnotations_attribute {
    u2              attribute_name_index;
    u4              attribute_length;
    u2              num_annotations;
    type_annotation annotations[num_annotations];
}
</div>

<div class="w3-panel w3-light-grey w3-border w3-round">
    <p>
        对于<code>type_annotation</code>的类型，可以参考<a href="/archive/java/classfile/attribute_perspective/type_annotation.html" target="_blank">这里</a>。
    </p>
</div>

<p>
    The items of the <code>RuntimeInvisibleTypeAnnotations_attribute</code> structure are as follows:
</p>

<ul>
    <li>
        <code>attribute_name_index</code>: The value of the <code>attribute_name_index</code> item must be a valid index into the <code>constant_pool</code> table. The <code>constant_pool</code> entry at that index must be a <code>CONSTANT_Utf8_info</code> structure representing the string "RuntimeInvisibleTypeAnnotations".
    </li>
    <li>
        <code>attribute_length</code>: The value of the <code>attribute_length</code> item indicates the length of the attribute, excluding the initial six bytes.
    </li>
    <li>
        <code>num_annotations</code>: The value of the <code>num_annotations</code> item gives the number of run-time invisible type annotations represented by the structure.
    </li>
    <li>
        <code>annotations[]</code>: Each entry in the <code>annotations</code> table represents a single run-time invisible annotation on a type used in a declaration or expression.
    </li>
</ul>

<h2>Examples</h2>

<div title="MyTag.java" class="javacode">
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target({ElementType.TYPE_PARAMETER, ElementType.TYPE_USE})
@Retention(RetentionPolicy.RUNTIME)
public @interface MyTag {
}
</div>

<h3>First Example</h3>

<div title="MyTag.java" class="javacode">
public class HelloWorld {
    public void test() {
        @MyTag String str = null; // 注意，MyTag修饰String类型
    }
}
</div>

<div title="RuntimeVisibleTypeAnnotations" hidden class="plaintext">
constant_pool_count='0015' (21)
constant_pool
    ......
    |014| CONSTANT_Utf8 {Value='RuntimeVisibleTypeAnnotations', HexCode='01001D52756E74696D6556697369626C6554797065416E6E6F746174696F6E73'}
    |015| CONSTANT_Utf8 {Value='Lsample/MyTag;', HexCode='01000E4C73616D706C652F4D795461673B'}
    ......
=== === ===  === === ===  === === ===
attributes_count='0003' (3)
attributes
......
--->|002| RuntimeVisibleTypeAnnotations:
HexCode: 000E00000010000140000100020001000100000F0000
attribute_name_index='000E' (#14)
attribute_length='00000010' (16)
num_annotations='0001' (1)
annotations[0] {
    target_type='40' (64)
    target_info {
        localvar_target {
            table_length='0001' (1)
            table[0] {
                start_pc='0002' (2)
                length='0001' (1)
                index='0001' (1)
            }
        }
    }
    target_path {
        path_length='00' (0)
    }
    type_index='000F' (#15)
    num_element_value_pairs='0000' (0)
}
</div>

<h3>Second Example</h3>

<div title="MyTag.java" class="javacode">
public class HelloWorld&lt;@MyTag T&gt; {
    //
}
</div>

<div title="RuntimeInvisibleTypeAnnotations" hidden class="plaintext">
constant_pool_count='0016' (22)
constant_pool
    ......
    |017| CONSTANT_Utf8 {Value='RuntimeVisibleTypeAnnotations', HexCode='01001D52756E74696D6556697369626C6554797065416E6E6F746174696F6E73'}
    |018| CONSTANT_Utf8 {Value='Lsample/MyTag;', HexCode='01000E4C73616D706C652F4D795461673B'}
    ......
attributes_count='0003' (3)
attributes
......
--->|002| RuntimeVisibleTypeAnnotations:
HexCode: 001100000009000100000000120000
attribute_name_index='0011' (#17)
attribute_length='00000009' (9)
num_annotations='0001' (1)
annotations[0] {
    target_type='00' (0)
    target_info {
        type_parameter_target {
            type_parameter_index='00' (#0)
        }
    }
    target_path {
        path_length='00' (0)
    }
    type_index='0012' (#18)
    num_element_value_pairs='0000' (0)
}
</div>
